<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <script>
        // Helper function to calculate years between dates as of 2568 BE
function calculateYearsBetween(startDate, endDate = "01/01/2568") {
    if (!startDate || startDate === "null") return 0;
    const [startDay, startMonth, startYear] = startDate.split("/").map(Number);
    const [endDay, endMonth, endYear] = endDate.split("/").map(Number);
    
    let years = endYear - startYear;
    if (endMonth < startMonth || (endMonth === startMonth && endDay < startDay)) {
        years--;
    }
    return years;
}

// Decoration levels in order from lowest to highest
const DECORATION_LEVELS = [
    "บ.ม.", // เบญจมาภรณ์มงกุฎไทย
    "บ.ช.", // เบญจมาภรณ์ช้างเผือก
    "จ.ม.", // จัตุรถาภรณ์มงกุฎไทย
    "จ.ช.", // จัตุรถาภรณ์ช้างเผือก
    "ต.ม.", // ตริตาภรณ์มงกุฎไทย
    "ต.ช.", // ตริตาภรณ์ช้างเผือก
    "ท.ม.", // ทวีติยาภรณ์มงกุฎไทย
    "ท.ช.", // ทวีติยาภรณ์ช้างเผือก
    "ป.ม.", // ประถมาภรณ์มงกุฎไทย
    "ป.ช.", // ประถมาภรณ์ช้างเผือก
];

// Get next decoration level
function getNextDecoration(currentDecoration) {
    if (!currentDecoration || currentDecoration === "null") return DECORATION_LEVELS[0];
    const currentIndex = DECORATION_LEVELS.findIndex(d => currentDecoration.includes(d));
    if (currentIndex === -1 || currentIndex === DECORATION_LEVELS.length - 1) return null;
    return DECORATION_LEVELS[currentIndex + 1];
}

function calculateDecoration({
    personal_type_input,
    pos_type_input,
    pos_lev_input,
    beg_pos_date_input,
    pos_lev_date_input,
    salary_input,
    salary5y_input,
    last_ins_code_name_full_input,
    last_ins_date_input
}) {
    // Calculate relevant periods
    const serviceYears = calculateYearsBetween(beg_pos_date_input);
    const lastInsYears = calculateYearsBetween(last_ins_date_input);
    
    // Check if received decoration in previous year
    if (lastInsYears === 0) {
        return "ไม่เสนอขอพระราชทานเครื่องราชฯ ในปีติดกัน";
    }

    // Handle different personal types
    switch (personal_type_input) {
        case "ข้าราชการ": {
            if (pos_type_input === "วิชาการ") {
                return handleAcademicPosition({
                    pos_lev_input,
                    serviceYears,
                    lastInsYears,
                    salary_input,
                    salary5y_input,
                    last_ins_code_name_full_input
                });
            } else if (pos_type_input === "ทั่วไป") {
                return handleGeneralPosition({
                    pos_lev_input,
                    serviceYears,
                    salary_input,
                    last_ins_code_name_full_input
                });
            }
            break;
        }
        
        case "ลูกจ้างประจำ": {
            if (serviceYears < 8) return "คุณสมบัติไม่ถึงเกณฑ์";
            if (salary_input >= 8340 && salary_input <= 15050) {
                const nextDec = getNextDecoration(last_ins_code_name_full_input);
                if (!nextDec || nextDec !== "บ.ม.") {
                    return "ได้รับพระราชทานเครื่องราชฯ ชั้นสูงสุดของระดับตำแหน่งแล้ว";
                }
                return `เครื่องราชอิสริยาภรณ์ชั้นถัดไป: เบญจมาภรณ์มงกุฎไทย (บ.ม.)`;
            }
            break;
        }
        
        case "พนักงานราชการ": {
            return handleGovernmentEmployee({
                pos_type_input,
                pos_lev_input,
                serviceYears,
                lastInsYears,
                last_ins_code_name_full_input
            });
        }
    }
    
    return "คุณสมบัติไม่ถึงเกณฑ์";
}

function handleAcademicPosition({
    pos_lev_input,
    serviceYears,
    lastInsYears,
    salary_input,
    salary5y_input,
    last_ins_code_name_full_input
}) {
    const maxDecorations = {
        "ปฏิบัติการ": "ต.ม.",
        "ชำนาญการ": "ท.ช.",
        "ชำนาญการพิเศษ": "ป.ม.",
        "เชี่ยวชาญ": "ป.ม."
    };

    // Check if already has highest decoration for position
    if (last_ins_code_name_full_input !== "null") {
        const maxDec = maxDecorations[pos_lev_input];
        if (last_ins_code_name_full_input.includes(maxDec)) {
            return "ได้รับพระราชทานเครื่องราชฯ ชั้นสูงสุดของระดับตำแหน่งแล้ว";
        }
    }

    switch (pos_lev_input) {
        case "ปฏิบัติการ": {
            if (serviceYears < 5) return "คุณสมบัติไม่ถึงเกณฑ์";
            return "เครื่องราชอิสริยาภรณ์ชั้นถัดไป: ตริตาภรณ์มงกุฎไทย (ต.ม.)";
        }
        
        case "ชำนาญการ": {
            if (last_ins_code_name_full_input.includes("ต.ม.")) {
                if (salary5y_input >= 22140) {
                    return "เครื่องราชอิสริยาภรณ์ชั้นถัดไป: ทวีติยาภรณ์ช้างเผือก (ท.ช.)";
                }
                if (salary_input >= 22140) {
                    return "เครื่องราชอิสริยาภรณ์ชั้นถัดไป: ทวีติยาภรณ์มงกุฎไทย (ท.ม.)";
                }
                return "เครื่องราชอิสริยาภรณ์ชั้นถัดไป: ตริตาภรณ์ช้างเผือก (ต.ช.)";
            }
            break;
        }
        
        case "ชำนาญการพิเศษ": {
            if (salary_input >= 58390 && lastInsYears >= 5) {
                return "เครื่องราชอิสริยาภรณ์ชั้นถัดไป: ประถมาภรณ์มงกุฎไทย (ป.ม.)";
            }
            return "เครื่องราชอิสริยาภรณ์ชั้นถัดไป: ทวีติยาภรณ์ช้างเผือก (ท.ช.)";
        }
        
        case "เชี่ยวชาญ": {
            if (last_ins_code_name_full_input.includes("ท.ช.")) {
                return "เครื่องราชอิสริยาภรณ์ชั้นถัดไป: ประถมาภรณ์มงกุฎไทย (ป.ม.)";
            }
            break;
        }
    }
    
    return "คุณสมบัติไม่ถึงเกณฑ์";
}

function handleGeneralPosition({
    pos_lev_input,
    serviceYears,
    salary_input,
    last_ins_code_name_full_input
}) {
    if (pos_lev_input === "ปฏิบัติงาน") {
        const maxDec = "จ.ช.";
        if (last_ins_code_name_full_input.includes(maxDec)) {
            return "ได้รับพระราชทานเครื่องราชฯ ชั้นสูงสุดของระดับตำแหน่งแล้ว";
        }

        if (serviceYears < 5) return "คุณสมบัติไม่ถึงเกณฑ์";
        
        if (salary_input < 10190) {
            if (serviceYears >= 10) {
                return "เครื่องราชอิสริยาภรณ์ชั้นถัดไป: เบญจมาภรณ์ช้างเผือก (บ.ช.)";
            }
            return "เครื่องราชอิสริยาภรณ์ชั้นถัดไป: เบญจมาภรณ์มงกุฎไทย (บ.ม.)";
        } else {
            if (serviceYears >= 10) {
                return "เครื่องราชอิสริยาภรณ์ชั้นถัดไป: จัตุรถาภรณ์ช้างเผือก (จ.ช.)";
            }
            return "เครื่องราชอิสริยาภรณ์ชั้นถัดไป: จัตุรถาภรณ์มงกุฎไทย (จ.ม.)";
        }
    }
    
    return "คุณสมบัติไม่ถึงเกณฑ์";
}

function handleGovernmentEmployee({
    pos_type_input,
    pos_lev_input,
    serviceYears,
    lastInsYears,
    last_ins_code_name_full_input
}) {
    if (pos_type_input === "กลุ่มงานบริการ") {
        if (serviceYears < 5) return "คุณสมบัติไม่ถึงเกณฑ์";
        return "เครื่องราชอิสริยาภรณ์ชั้นถัดไป: เบญจมาภรณ์มงกุฎไทย (บ.ม.)";
    }
    
    if (pos_type_input === "กลุ่มงานเชี่ยวชาญพิเศษ" && pos_lev_input === "สากล") {
        const maxDec = "ป.ช.";
        if (last_ins_code_name_full_input.includes(maxDec)) {
            return "ได้รับพระราชทานเครื่องราชฯ ชั้นสูงสุดของระดับตำแหน่งแล้ว";
        }

        if (last_ins_code_name_full_input.includes("ท.ม.") && lastInsYears >= 5) {
            return "เครื่องราชอิสริยาภรณ์ชั้นถัดไป: ทวีติยาภรณ์ช้างเผือก (ท.ช.)";
        }
        
        if (last_ins_code_name_full_input.includes("ป.ม.") && lastInsYears >= 3) {
            return "เครื่องราชอิสริยาภรณ์ชั้นถัดไป: ประถมาภรณ์ช้างเผือก (ป.ช.)";
        }
    }
    
    return "คุณสมบัติไม่ถึงเกณฑ์";
}

// Test Cases
const testCases = [
    {
        caseNum: 1,
        description: "ข้าราชการ/วิชาการ/ปฏิบัติการ - First decoration request with 5 years service",
        input: {
            personal_type_input: "ข้าราชการ",
            pos_type_input: "วิชาการ",
            pos_lev_input: "ปฏิบัติการ",
            beg_pos_date_input: "01/01/2563",
            pos_lev_date_input: null,
            salary_input: 18000,
            salary5y_input: null,
            last_ins_code_name_full_input: "ไม่เคยได้รับพระราชทานเครื่องราชฯ",
            last_ins_date_input: null
        },
        expected: "เครื่องราชอิสริยาภรณ์ชั้นถัดไป: ตริตาภรณ์มงกุฎไทย (ต.ม.)"
    }
];

// Test runner
function runTests() {
    console.log("Running Royal Decoration Calculator Tests...\n");
    let passedTests = 0;
    let failedTests = 0;

    testCases.forEach((testCase) => {
        console.group(`Test Case ${testCase.caseNum}: ${testCase.description}`);
        const result = calculateDecoration(testCase.input);
        const passed = result === testCase.expected;
        
        console.log(`Input:    `, testCase.input);
        console.log(`Expected: ${testCase.expected}`);
        console.log(`Actual:   ${result}`);
        console.log(`Status:   ${passed ? "✅ PASSED" : "❌ FAILED"}`);
        
        if (passed) {
            passedTests++;
        } else {
            failedTests++;
            console.log("Debugging info:");
            console.log("- Result type:", typeof result);
            console.log("- Expected type:", typeof testCase.expected);
        }
        console.groupEnd();
        console.log("-".repeat(80) + "\n");
    });

    console.log("Test Summary:");
    console.log(`Total Tests: ${testCases.length}`);
    console.log(`Passed: ${passedTests}`);
    console.log(`Failed: ${failedTests}`);
    console.log(`Success Rate: ${(passedTests / testCases.length * 100).toFixed(2)}%`);
}

// Run tests when page loads
window.onload = runTests;
</script>
</body>
</html>